import{_ as s,c as i,o as a,a1 as n}from"./chunks/framework.CG9TfmPt.js";const C=JSON.parse('{"title":"vastbase日常运维汇总","description":"","frontmatter":{},"headers":[],"relativePath":"DevOps/MySQL/vastbase常用操作.md","filePath":"DevOps/MySQL/vastbase常用操作.md"}'),h={name:"DevOps/MySQL/vastbase常用操作.md"},l=n(`<h1 id="vastbase日常运维汇总" tabindex="-1">vastbase日常运维汇总 <a class="header-anchor" href="#vastbase日常运维汇总" aria-label="Permalink to &quot;vastbase日常运维汇总&quot;">​</a></h1><h2 id="_1、连接数据库" tabindex="-1">1、连接数据库 <a class="header-anchor" href="#_1、连接数据库" aria-label="Permalink to &quot;1、连接数据库&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#切换数据库用户</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">su</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vastbase</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vsql</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -r</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vastbase</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vsql</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vastbase</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -h</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10.53.136.14</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -U</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5432</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (输入密码)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_ctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> start</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_ctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stop</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_ctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_ctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status</span></span></code></pre></div><h2 id="_2、常用命令" tabindex="-1">2、常用命令 <a class="header-anchor" href="#_2、常用命令" aria-label="Permalink to &quot;2、常用命令&quot;">​</a></h2><div class="language-css vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">css</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\h</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -- 查看帮助</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\l</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -- 列出所有数据库</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dbname -- 切换数据库</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\d</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">t -- 列出当前数据库所有表</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\d</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tablename -- 列出表的所有字段</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\d</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tablename --列出表的基本情况</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\d</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i -- 查看索引</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\d</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tS -- 查看系统表</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\d</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">u</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\d</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">g</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> --查看用户</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\d</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">p -- 显示表的权限分配情况</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\d</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">n -- 显示schemas</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">onninfo -- 显示当前登录信息</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">1、查看某用户的系统权限</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">SELECT</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FROM  pg_roles WHERE rolname=&#39;postgres&#39;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">2、查看某用户的表权限</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">select</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> from information_schema</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.table_privileges</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> where grantee=&#39;postgres&#39;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">3、查看某用户的usage权限</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">select</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> from information_schema</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.usage_privileges</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> where grantee=&#39;postgres&#39;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">4、查看某用户在存储过程函数的执行权限</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">select</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> from information_schema</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.routine_privileges</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> where grantee=&#39;postgres&#39;; </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">5、查看某用户在某表的列上的权限</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">select</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> from information_schema</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.column_privileges</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> where grantee=&#39;postgres&#39;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">6、查看当前用户能够访问的数据类型</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">select</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> from information_schema</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.data_type_privileges</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ; </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">7、查看用户自定义类型上授予的USAGE权限</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">select</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> from information_schema</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.udt_privileges</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> where grantee=&#39;postgres&#39;;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">show sql_compatibility; -- 查看数据库初始化时设置的兼容模式,取值范围：A、B、C、PG、MSSQL分别表示兼容Oracle、MySQL、Teradata、PostgreSQL和SQL Server</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">#查询当前的schema</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> current_schema; </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">#切换路径到对应的schema下</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> search_path to ccci_settlement;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">#执行sql脚本</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vsql -d vastbase -f sql</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.sql</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /home/vastbase/sql</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.sql</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (命令行执行)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">#命令行导出导入某张表数据</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">opy testtab1 to /home/vastbase/testtab1</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.txt</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">opy (</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> col1,col2 from testtab1) to /home/vastbase/testtab1</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.txt</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">truncate </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">table</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> testtab1</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">opy testtab1 from /home/vastbase/testtab1</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.txt</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vb_guc </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -I all -N all -c &quot;wal_level=logical&quot; --修改设置数据库参数值</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vsql -c &quot;show wal_level&quot; --查询数据库参数当前值</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vb_guc </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -I all -N all -c &quot;max_wal_senders=10&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vsql -c &quot;show max_wal_senders&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vb_ctl reload --加载配置</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">#查看数据库实例状态</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vb_ctl status </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">#查询主从同步状态</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vb_ctl query</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cp -a /data/vastbasedata/install/data/dn /data/vastbasedata/install/data/dn_bak20250102 --备份</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">#查看license授权</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">show license_path;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vb_licensetool --dump /home/vastbase/</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.license</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">#查看表膨胀情况</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reltuples,relpages,relname from pg_class where relname = &#39;tk_kdyq_yq_xm&#39;;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">#手动清理回收</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vacuum full tk_kdyq_yq_xm;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">#解锁或锁定账号</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">alter user joe account unlock;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">alter user joe account lock;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">#切换用户</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> - [</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">user_name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">#查询数据库启动时间</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vsql -c &quot;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pg_postmaster_start_time();&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">#查询数据库的编码方式</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vsql -c &quot;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> getdatabaseencoding();&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">#查询数据库服务版本</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vsql -c &quot;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> version();&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PostgreSQL 9</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.2.4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> on </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">aarch64-unknown-linux-gnu</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, compiled by </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">g</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (GCC) 7</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.3.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, 64-bit</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">#查询vastbase产品版本信息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vsql -c &quot;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vb_version();&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">#数据库日志目录</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/data/vastbasedata/log/omm/vastbase/pg_log/dn_6001</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">#查询复制槽</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">select</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> from pg_replication_slots;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">#查看集群状态-高可用组件，主备集群下主恢复完数据以后，备会自动build数据，磁盘数据量会变化</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">has_ctl query -Civ</span></span></code></pre></div><h2 id="_3、创建用户并赋权" tabindex="-1">3、创建用户并赋权 <a class="header-anchor" href="#_3、创建用户并赋权" aria-label="Permalink to &quot;3、创建用户并赋权&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">create</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> user</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_user</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> with</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> password</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;ccci@2024&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">create</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> user</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_read_user</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> with</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> password</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;read#2024&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">grant</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> connect</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> database</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;ccci_contract&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">\\c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_contract</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">grant</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> usage</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> schema</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_contract</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">grant</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> select</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tables</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> in</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> schema</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_contract</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">grant</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> privileges</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tables</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> in</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> schema</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_contract</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 给用户赋予某种角色</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">create</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> user</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sysadmin</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> with</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SYSADMIN</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> password</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Bigdata@123&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">alter</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> user</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_user</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SYSADMIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 根据需要赋予any权限</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GRANT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CREATE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TABLE,SELECT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TABLE,INSERT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TABLE,UPDATE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TABLE,DELETE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TABLE,CREATE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SEQUENCE,CREATE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> INDEX,CREATE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> FUNCTION,EXECUTE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> FUNCTION,CREATE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PACKAGE,EXECUTE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PACKAGE,CREATE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TYPE,ALTER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TYPE,DROP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TYPE,ALTER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SEQUENCE,DROP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SEQUENCE,SELECT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SEQUENCE,ALTER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> INDEX,DROP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> INDEX,CREATE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SYNONYM,DROP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SYNONYM,CREATE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TRIGGER,ALTER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TRIGGER,DROP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TRIGGER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TO</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> qx_rw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 权限分类</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -- 允许对指定的表、视图、序列执行select命令</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">insert</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 允许对指定的表执行insert命令</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 允许对声明的表中任意字段执行update命令</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">delete</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 允许执行delete命令删除指定表中的数据</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">truncate</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 允许执行truncate语句删除指定表中的所有记录</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">references</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 创建一个外键约束，必须拥有参考表和被参考表的references权限</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">create</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 对于库允许在数据库里创建新模式，对于模式允许创建新的对象，对于表空间允许创建表</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">connect</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 允许用户连接到指定的数据库</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">temporary</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 允许在指定的数据库中创建临时表</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">execute</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 允许使用指定的函数</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">usage</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 对于模式，允许访问包含在指定模式中的对象</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">alter</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 修改数据库表的结构，非表中的数据</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">drop</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 允许用户删除指定的对象，库</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">index</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 允许用户在指定的表上创建索引并管理索引</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">comment</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 允许用户定义或修改指定对象的注释</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">VACUUM</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 允许用户对指定的表执行ANALYZE和VACUUM操作</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ALL</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PRIVILEGES</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 一次性给指定用户/角色赋予所有可赋予的权限。只有系统管理员有权执行GRANT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ALL</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PRIVILEGES</span></span></code></pre></div><h2 id="_4、修改数据库大小写敏感性" tabindex="-1">4、修改数据库大小写敏感性 <a class="header-anchor" href="#_4、修改数据库大小写敏感性" aria-label="Permalink to &quot;4、修改数据库大小写敏感性&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># lower_case_column_names参数数据库返回字段名的大小写敏感性</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查看参数方式</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">su</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vastbase</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vsql</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -r</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vastbase</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">show</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> lower_case_table_names</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">show</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> lower_case_column_names</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 修改参数方式</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">su</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vastbase</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $PGDATA</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vi</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> postgresql.conf</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lower_case_table_names</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --对象名大小写不敏感</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lower_case_column_names</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --字段大小写不敏感</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">wq保存</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 重启数据库使配置生效</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_ctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span></span></code></pre></div><h2 id="_5、修改id自增" tabindex="-1">5、修改id自增 <a class="header-anchor" href="#_5、修改id自增" aria-label="Permalink to &quot;5、修改id自增&quot;">​</a></h2><div class="language-mysql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">mysql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>SELECT sequence_schema, sequence_name FROM information_schema.sequences;</span></span>
<span class="line"><span>grant usage on sequence ccci_infra.file_info_id_seq to ccci_user;</span></span></code></pre></div><h2 id="_6、修改空闲会话超时设置-会影响seata事务回滚" tabindex="-1">6、修改空闲会话超时设置（会影响seata事务回滚） <a class="header-anchor" href="#_6、修改空闲会话超时设置-会影响seata事务回滚" aria-label="Permalink to &quot;6、修改空闲会话超时设置（会影响seata事务回滚）&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># session_timeout 空闲会话超时设置,0为不限时间</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">su</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vastbase</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vsql</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;show session_timeout&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_guc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> set</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -I</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -N</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;session_timeout=0&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_ctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> reload</span></span></code></pre></div><h2 id="_7、归档文件删除-archive-wals" tabindex="-1">7、归档文件删除（archive_wals） <a class="header-anchor" href="#_7、归档文件删除-archive-wals" aria-label="Permalink to &quot;7、归档文件删除（archive_wals）&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 可以在vastbase用户下建一个清理的定时任务，如下</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> find /data/archive_wals -maxdepth 1 -name </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;00*&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -mtime +7 -exec rm -f {} </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># /data/archive_wals/替换成环境实际的归档目录路径</span></span></code></pre></div><h2 id="_8、海量vem监控配置" tabindex="-1">8、海量VEM监控配置 <a class="header-anchor" href="#_8、海量vem监控配置" aria-label="Permalink to &quot;8、海量VEM监控配置&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># IP: 10.53.143.14</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 安装包目录: /usr/local/src/vastem_2.16.3</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 安装目录: /opt/vem</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 启停监控操作</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./control.sh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stop</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./control.sh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> start</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./control.sh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 报错是因为缺少libssl.so.10</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">find</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libssl.so.10</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">yum</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -y</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> compat-openssl10</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">psql</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> postgres</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -U</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vastem</span></span></code></pre></div><h2 id="_9、动态内存修改" tabindex="-1">9、动态内存修改 <a class="header-anchor" href="#_9、动态内存修改" aria-label="Permalink to &quot;9、动态内存修改&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 显示某个数据库节点内存使用情况</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> * from pg_total_memory_detail;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">elect</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> when</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">memorytype</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;max_process_memory&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      then</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;VastbaseG100实例允许占用的最大内存&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     when</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memorytype=&#39;process_used_memory&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     then</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;数据库进程占用的内存&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     when</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memorytype=&#39;max_dynamic_memory&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      then</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;最大动态内存&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     when</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memorytype=&#39;dynamic_used_memory&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     then</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;已使用的动态内存&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     when</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memorytype=&#39;dynamic_peak_memory&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     then</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;内存的动态峰值&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     when</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memorytype=&#39;dynamic_used_shrctx&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     then</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;最大动态共享内存上下文&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     when</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memorytype=&#39;dynamic_peak_shrctx&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     then</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;共享内存上下文的动态峰值&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     when</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memorytype=&#39;max_shared_memory&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       then</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;最大共享内存&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     when</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memorytype=&#39;shared_used_memory&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      then</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;已使用的共享内存&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     when</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memorytype=&#39;max_cstore_memory&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       then</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;列存所允许使用的最大内存&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     when</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memorytype=&#39;cstore_used_memory&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      then</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;列存已使用的内存大小&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     when</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memorytype=&#39;max_sctpcomm_memory&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  then</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;sctp通信所允许使用的最大内存&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     when</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memorytype=&#39;sctpcomm_used_memory&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    then</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;sctp通信已使用的内存大小&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     when</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memorytype=&#39;sctpcomm_peak_memory&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    then</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;sctp通信的内存峰值&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     when</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memorytype=&#39;other_used_memory&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       then</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;其他已使用的内存大小&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     when</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memorytype=&#39;gpu_max_dynamic_memory&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  then</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;GPU最大动态内存&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     when</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memorytype=&#39;gpu_dynamic_used_memory&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> then</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;GPU已使用的动态内存&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     when</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memorytype=&#39;gpu_dynamic_peak_memory&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> then</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;GPU内存的动态峰值&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     when</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memorytype=&#39;pooler_conn_memory&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      then</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;链接池申请内存计数&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     when</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memorytype=&#39;pooler_freeconn_memory&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  then</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;链接池空闲连接的内存计数&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    when</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memorytype=&#39;storage_compress_memory&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> then</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;存储模块压缩使用的内存大小&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     when</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memorytype=&#39;udf_reserved_memory&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     then</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;UDF预留的内存大小&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	 else</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> memorytype</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> end</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> as</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memorytype</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	 ,memorymbytes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pg_total_memory_detail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	 </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 设置数据库节点可用的最大物理内存38GB</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">show</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> max_process_memory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 设置Vastbase使用的共享内存大小18GB</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">show</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> shared_buffers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 计算内核参数的值</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;kernel.sem= \`</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /proc/sys/kernel/sem\`&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /proc/meminfo</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> MemTotal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">awk</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> {&#39;print $2&#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">1024</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">0.8/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getconf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PAGE_SIZE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">awk</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;{printf &quot;kernel.shmall=%d\\n&quot;,$1}&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /proc/meminfo</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> MemTotal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> awk</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;{printf &quot;kernel.shmmax=%d\\n&quot;,$2*1024*0.8}&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;kernel.shmmni =\`</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /proc/sys/kernel/shmmni\`&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kernel.sem</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 250</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 6400000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    25600</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kernel.shmall</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=611078</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kernel.shmmax</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=40047634022</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kernel.shmmni</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8192</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 修改操作系统内核参数</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/sysctl.conf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fs.aio-max-nr</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=1048576</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fs.file-max</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 76724600</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kernel.sem</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 250</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 6400000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 25600</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kernel.shmall</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 611078</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kernel.shmmax</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 40047634022</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kernel.shmmni</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8192</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.core.netdev_max_backlog</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10000</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.core.rmem_default</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 262144</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.core.rmem_max</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4194304</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.core.wmem_default</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 262144</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.core.wmem_max</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4194304</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.core.somaxconn</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4096</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.ipv4.tcp_fin_timeout</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vm.overcommit_memory</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vm.swappiness</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.ipv4.ip_local_port_range</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 40000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 65535</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fs.nr_open</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 20480000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sysctl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 修改配置文件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vim</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $PGDATA</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/postgresql.conf</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">work_mem</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =4MB</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">shared_buffers</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 18GB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">wal_buffers</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">128MB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">max_process_memory</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">38GB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">effective_cache_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">38GB</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">maintenance_work_mem</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 512MB</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_ctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> reload</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">---</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ---</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ---</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">max_dynamic_memory</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> max_process_memory</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cstore_buffers</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> udf_memory</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> shared_memory</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> backend_reserved_memory</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">max_dynamic_memory和max_process_memory正相关，和shared_buffers、max_connections、work_mem、maintenance_work_mem这些负相关，这些参数是相互影响的</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">shared_buffers</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 最大共享内存通常按照OS_MEM（1/4）设置</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">max_process_memory</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 实例允许占用的最大内存按照OS_MEM（3/4）设置</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">数据库服务器总内存32G：</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">max_connections</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">500</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">shared_buffers</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">8GB</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">max_process_memory</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 24GB</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">effective_cache_size</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 24GB</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">maintenance_work_mem</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 512MB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">work_mem</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">4MB</span></span></code></pre></div><h2 id="_10、查看连接数" tabindex="-1">10、查看连接数 <a class="header-anchor" href="#_10、查看连接数" aria-label="Permalink to &quot;10、查看连接数&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查看当前连接总数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count(1) from pg_stat_activity;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查看最大连接数</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">show</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> max_connections</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 修改配置文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">max_connections</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">2000</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 32G</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查询参数生效是否需要重启，参数级别是postmaster的需重启生效 </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> postmaster，*  from  pg_settings  where name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;shared_buffers&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><h2 id="_11、许可替换" tabindex="-1">11、许可替换 <a class="header-anchor" href="#_11、许可替换" aria-label="Permalink to &quot;11、许可替换&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 许可路径</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">license_path</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/data/vastbasedata/install/app/.license&#39;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 步骤</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># root用户执行</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mv</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/vastbasedata/install/app/.license</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/vastbase/install/app/ol</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 上传的授权文件</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/vastbasedata/install/app/.license</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chown</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vastbase</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vastbase</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/vastbasedata/install/app/.license</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># vastbase用户执行</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vim</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $PGDATA</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/postgresql.conf</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#末行添加</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">license_path</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/data/vastbasedata/install/app/.license&#39;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#执行检查有效期</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_licensetool</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --dump=/data/vastbasedata/install/app/.license</span></span></code></pre></div><h2 id="_12、statscollector异常写入导致io下降" tabindex="-1">12、statscollector异常写入导致IO下降 <a class="header-anchor" href="#_12、statscollector异常写入导致io下降" aria-label="Permalink to &quot;12、statscollector异常写入导致IO下降&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#原因：autovacuum相关参数的调整导致autovacuum执行更频繁</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vacuum_cost_limit</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">200</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> --</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  #自动vacuum操作里使用的开销限制数值</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">autovacuum_max_workers</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">3</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> --</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   #能同时运行的自动清理线程的最大数量</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">autovacuum_naptime</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">10min</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> --</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">20s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> （改回10min）</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  #设置两次自动清理操作的时间间隔</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">autovacuum_vacuum_cost_delay</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">20ms</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> --</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  #设置在自动vacuum操作里使用的开销延迟数值</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">autovacuum_vacuum_scale_factor</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">0.2</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> --</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">0.02</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> （改回0.2）</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #设置触发一个VACUUM时增加到autovacuum_vacuum_threshold的表大小的缩放系数</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#以上参数的调整导致了autovacuum更频繁的执行，表的死元组会被更快的回收，统计信息会更准确，但同时也会消耗更多的cpu及io资源</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">enable_wdr_snapshot</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  #数据库postgres下新建snapshot导致暂用几十个G，最好关掉</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">wdr_snapshot_retention_days</span></span></code></pre></div><h2 id="_13、vastbase备份" tabindex="-1">13、vastbase备份 <a class="header-anchor" href="#_13、vastbase备份" aria-label="Permalink to &quot;13、vastbase备份&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">1、创建备份目录</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/backup/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chown</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vastbase:vastbase</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/backup</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">2、初始化备份目录</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_probackup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> init</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -B</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/backup</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">3、添加备份实例</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_probackup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add-instance</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -B</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/backup</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/vastbasedata/install/data/dn</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --instance=ylt-prod-vb</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">4、设置备份配置</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_probackup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> set-config</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -B</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/backup</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --instance=ylt-prod-vb</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/vastbasedata/install/data/dn</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --retention-redundancy=7</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --retention-window=7</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --wal-depth=2</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --compress-algorithm=zlib</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --compress-level=6</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vastbase</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5432</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --log-level-file=info</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --log-filename=full_backup-%Y%m%d.log</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --log-rotation-size=50MB</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">5、查看备份配置</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_probackup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> show-config</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -B</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/backup</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --instance=ylt-prod-vb</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">6、查看备份内容</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_probackup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -B</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/backup</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">7、全量备份</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_probackup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> backup</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -B</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/backup</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --instance=ylt-prod-vb</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -b</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> full</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -j</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --delete-wal</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --delete-expired</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_probackup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> backup</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -B</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/backup</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --instance=ylt-prod-vb</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -b</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> full</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -j</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">8、校验备份</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_probackup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> validate</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -B</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/backup/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --instance=ylt-prod-vb</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -j</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SVZUC4</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">9、删除备份</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_probackup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> delete</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -B</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/backup</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --instance=ylt-prod-vb</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SQ4EKE</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">10、恢复备份</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $PGDATA</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -rf</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> *</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_probackup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restore</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -B</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/backup</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --instance</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ylt-prod-vb</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/vastbasedata/install/data/dn</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -j</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SVZUC4</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">---</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ---</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">逻辑备份</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">\\l</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">\\c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_order</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">\\dt</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> search_path</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_order</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/data/dump_data/0516</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_dump</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -C</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_contract_202505160859.sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_contract</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_dump</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -C</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_order_202505160901.sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_order</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_dump</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -C</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_storage_202505160921.sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_storage</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_dump</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -C</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_settlement_202505160922.sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_settlement</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tar</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -zcvf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ylt-prod-data_0516.tar.gz</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tar</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -zxvf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ylt-prod-data_0516.tar.gz</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mv</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0516</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ylt-prod-data_0516</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chown</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -R</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vastbase:vastbase</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ylt-prod-data_0516</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/dump_data/ylt-prod-data_0516</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vsql</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -r</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">clean</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> connection</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> force</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> database</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_settlement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">\\i</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_settlement_202505160922.sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_settlement</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">---</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ---</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">逻辑备份2</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 生产环境 ccci_contract 库导入 PRE 环境步骤</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">1、备份</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PRE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 环境</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_contract</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 库</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_dump</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -C</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_contract_202505160859.sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_contract</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_dump</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -C</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_contract_</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">date</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +%Y%m%d%H%M%S</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_contract</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">2、备份生产环境</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_contract</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 库</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_dump</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -C</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_contract_202505160908.sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_contract</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_dump</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -C</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_contract_</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">date</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +%Y%m%d%H%M%S</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_contract</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">3、拷贝生产</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_contract</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 库备份到</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PRE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 服务器</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/dump_data/0521</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tar</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -czvf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ylt-prod-data_0521.tar.gz</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0521</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">scp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ylt-prod-data_0521.tar.gz</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root@10.53.136.15:/tmp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PBData#123</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">切换到PRE服务器上</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tar</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -xzf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ylt-prod-data_0521.tar.gz</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mv</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0521</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ylt-prod-data_0521</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mv</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ylt-prod-data_0521</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/dump_data/</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/dump_data/</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ylt-prod-data_0521/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">md5sum</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> （只能校验文件，不能校验文件夹）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">4、修改备份文件（替换用户名，备份文件内容中涉及到的数据库关键字处理）</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/dump_data/ylt-prod-data_0521</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sed</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;s/ccci_prod_user/ccci_user/g&#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> *</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_contract_20250521164411.sql</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CREATE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TABLE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sys_config下关键字key加引号，即&quot;key&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">5、停掉</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ltd-ccci-svc-contract</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 服务并手动清理</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PRE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 环境</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_contract</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 库的连接，确保导入时删库成功</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">clean</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> connection</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> force</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> database</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_contract</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">6、导入备份到</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PRE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 环境</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_contract</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 库</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vsql</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -r</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">\\i</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_contract_20250521164411.sql</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">7、验证导入的数据，检查表数量和表数据条数及表结构</span></span></code></pre></div><h2 id="_14、vastbase备份恢复" tabindex="-1">14、vastbase备份恢复 <a class="header-anchor" href="#_14、vastbase备份恢复" aria-label="Permalink to &quot;14、vastbase备份恢复&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mv</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /opt/software/vastdata</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /opt/software/vastdata_old</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /opt/software/vastdata</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_probackup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restore</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -B</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /opt/software/backup</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --instance</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> production</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SUB98Q</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /opt/software/vastdata</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_probackup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restore</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -B</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /opt/software/backup</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --instance</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> production</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --recovery-target-time=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2025-04-07 18:15:09+8&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /opt/software/vastdata</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_probackup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> validate</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -B</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /opt/software/backup</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --instance</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> production</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -j</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pg_controldata</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 得到识别号，修改pg_probackup.conf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#恢复数据，先恢复全备后不启动数据库，然后剩余的wal日志保存在一个目录下，通过在$PGDATAT目录下创建recovery.conf文件后启动数据库自动恢复数据</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">restore_command</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;cp /opt/software/backup/wal/production/%f %p&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">recovery_target_time</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;2025-04-08 18:15:09+08&#39;</span></span></code></pre></div><h2 id="_15、sql语句报内存不足" tabindex="-1">15、SQL语句报内存不足 <a class="header-anchor" href="#_15、sql语句报内存不足" aria-label="Permalink to &quot;15、SQL语句报内存不足&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 问题原因</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">排查会话内存使用情况发，数据库中存在大量的idle连接，idle连接会使用内存，导致动态内存达到上限，导致业务报错内存不足</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 优化建议</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">1、调整数据库参数sessiontimeout，对超时的idle连接进行释放。目前sessiontimeout</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=10min，表示会自动关闭超过10min的空闲连接，此值可进一步调小，前提是不会对业务产生影响</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">2、业务使用连接池，可以降低建立连接的代价，提高连接的使用率，防止连接用完不会收长时间占用内存。</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 数据库连接</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> state,count(*) from pg_stat_activity group by state order by 2; </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 数据库内存占用</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> * from pg_total_memory_detail; </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查看连接的内存占用</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a.client_addr,a.usename,a.state,a.query_start,a.pid,left(a.query,50),sum(d.totalsize/1000/1000)||&#39;MB&#39; from dbe_perf.session_memory_detail d,pg_stat_activity a where a.pid</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">right</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">d.sessid,14</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">group</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> by</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1,2,3,4,5,6</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> order</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> by</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 7</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> desc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 强制终止空闲的用户会话</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pg_terminate_backend(pid) from pg_stat_activity where state</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;idle&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div>`,31),k=[l];function p(t,e,F,r,d,y){return a(),i("div",null,k)}const E=s(h,[["render",p]]);export{C as __pageData,E as default};
