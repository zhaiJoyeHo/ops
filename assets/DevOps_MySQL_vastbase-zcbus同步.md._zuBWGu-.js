import{_ as s,c as i,o as a,a1 as n}from"./chunks/framework.CG9TfmPt.js";const y=JSON.parse('{"title":"ZCBUS数据实时同步","description":"","frontmatter":{},"headers":[],"relativePath":"DevOps/MySQL/vastbase-zcbus同步.md","filePath":"DevOps/MySQL/vastbase-zcbus同步.md"}'),h={name:"DevOps/MySQL/vastbase-zcbus同步.md"},k=n(`<h1 id="zcbus数据实时同步" tabindex="-1">ZCBUS数据实时同步 <a class="header-anchor" href="#zcbus数据实时同步" aria-label="Permalink to &quot;ZCBUS数据实时同步&quot;">​</a></h1><h2 id="_1、源库-云链通-基础配置" tabindex="-1">1、源库（云链通）基础配置 <a class="header-anchor" href="#_1、源库-云链通-基础配置" aria-label="Permalink to &quot;1、源库（云链通）基础配置&quot;">​</a></h2><blockquote><ul><li>先在一体机上停止从库，在从库进行配置后在主库做同样的配置</li></ul></blockquote><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_ctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_ctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> query</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -a</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/vastbasedata/install/data/dn</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/vastbasedata/install/data/dn_bak20250102</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#逻辑级别日志</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_guc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> set</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -I</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -N</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;wal_level=logical&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vsql</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;show wal_level&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#远程读日志线程，最少为1，建议大于等于10</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_guc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> set</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -I</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -N</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;max_wal_senders=10&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vsql</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;show max_wal_senders&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#设置日志保留个数，设置太小，日志自动删除后容易读不到日志</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_guc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> set</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -I</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -N</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;wal_keep_segments=16&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vsql</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;show wal_keep_segments&quot;</span></span></code></pre></div><h2 id="_2、源库zcbus配置" tabindex="-1">2、源库ZCBUS配置 <a class="header-anchor" href="#_2、源库zcbus配置" aria-label="Permalink to &quot;2、源库ZCBUS配置&quot;">​</a></h2><blockquote><ul><li>配置解析日志用户，允许谁来解析日志</li></ul></blockquote><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">su</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vastbase</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $PGDATA</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pg_hba.conf</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">host</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    replication</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     all</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">             10.53.141.121/32</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            md5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_ctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> reload</span></span></code></pre></div><blockquote><ul><li>需要同步的表打开补充日志</li></ul></blockquote><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">\\c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_settlement</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ALTER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TABLE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_settlement.credit_risk_group</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> REPLICA</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> IDENTITY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> FULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ALTER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TABLE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_settlement.credit_ledger_detail</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> REPLICA</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> IDENTITY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> FULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ALTER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TABLE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_settlement.credit_risk_safeguard</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> REPLICA</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> IDENTITY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> FULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ALTER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TABLE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_settlement.overdue_solution_apply</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> REPLICA</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> IDENTITY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> FULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ALTER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TABLE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_settlement.credit_exposure_bill</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> REPLICA</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> IDENTITY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> FULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ALTER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TABLE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_settlement.credit_overdue_detail</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> REPLICA</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> IDENTITY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> FULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ALTER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TABLE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_settlement.credit_exposure_customer_daily</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> REPLICA</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> IDENTITY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> FULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ALTER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TABLE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_settlement.credit_exposure_contract_daily</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> REPLICA</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> IDENTITY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> FULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ALTER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TABLE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_settlement.credit_exposure_no_contract_daily</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> REPLICA</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> IDENTITY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> FULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ALTER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TABLE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_settlement.credit_exposure_order_daily</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> REPLICA</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> IDENTITY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> FULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ALTER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TABLE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_settlement.credit_exposure_project_daily</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> REPLICA</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> IDENTITY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> FULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><blockquote><ul><li>DDL（数据定义语言，定义改变表的结构、数据类型、表之间的链接等操作）兼容配置</li></ul></blockquote><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#增量复制过程中，若有表结构修改则自动同步，若未添加次功能需人工参与</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#创建ddl_event_tbl表,用于存储ddl语句</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">create</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> schema</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">create</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> table</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus.ddl_event_tbl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">event</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> text,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tag</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> text,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">objid</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> oid,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">object_type</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> text,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">schema_name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> text,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">object_identity</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> text,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> text,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">op_time</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> timestamp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#创建函数zcbus_func_ddl_command（老的会导致后面赋权报错）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">create</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> or</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> replace</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> function</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus.zcbus_func_ddl_command</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">returns</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> event_trigger</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> as</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">declare</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  v1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  r</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> record</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">begin</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> query into v1 from pg_stat_activity where pid</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pg_backend_pid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> RAISE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> NOTICE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;ddl event:%, command:%&#39;,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tg_event,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tg_tag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TG_EVENT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ddl_command_end&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> then</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> into</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> r</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> FROM</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pg_event_trigger_ddl_commands</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> r.classid</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> then</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      insert</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> into</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus.ddl_event_tbl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">event,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tag,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> objid,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> object_type,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> schema_name,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> object_identity,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        values(TG_EVENT,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TG_TAG,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> r.objid,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> r.object_type,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> r.schema_name,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> r.object_identity,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> v1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TG_EVENT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;sql_drop&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> then</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TG_TAG</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> !=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;ALTER TABLE&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> then</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> into</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> r</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> FROM</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pg_event_trigger_dropped_objects</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      insert</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> into</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus.ddl_event_tbl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">event,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tag,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> object_type,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> schema_name,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> object_identity,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        values(TG_EVENT,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TG_TAG,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> r.object_type,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> r.schema_name,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> r.object_identity,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> v1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> language plpgsql strict;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#创建函数zcbus_func_ddl_command（新的）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">create</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> or</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> replace</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> function</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus.zcbus_func_ddl_command</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">returns</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> event_trigger</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> as</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">declare</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  v1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  r</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> record</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">begin</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> query into v1 from pg_stat_activity where pid</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pg_backend_pid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> RAISE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> NOTICE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;ddl event:%, command:%&#39;,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tg_event,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tg_tag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TG_EVENT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ddl_command_end&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> then</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TG_TAG</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> !=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;GRANT&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> then</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> into</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> r</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> FROM</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pg_event_trigger_ddl_commands</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> r.classid</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> then</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      insert</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> into</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus.ddl_event_tbl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">event,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tag,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> objid,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> object_type,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> schema_name,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> object_identity,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        values(TG_EVENT,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TG_TAG,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> r.objid,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> r.object_type,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> r.schema_name,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> r.object_identity,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> v1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TG_EVENT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;sql_drop&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> then</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TG_TAG</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> !=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;ALTER TABLE&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> then</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> into</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> r</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> FROM</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pg_event_trigger_dropped_objects</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      insert</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> into</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus.ddl_event_tbl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">event,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tag,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> object_type,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> schema_name,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> object_identity,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        values(TG_EVENT,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TG_TAG,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> r.object_type,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> r.schema_name,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> r.object_identity,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> v1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> language plpgsql strict;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#创建事件触发器</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CREATE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> EVENT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TRIGGER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus_et_ddl_command</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ddl_command_end</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> EXECUTE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PROCEDURE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus.zcbus_func_ddl_command</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CREATE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> EVENT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TRIGGER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus_et_ddl_drop</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sql_drop</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> EXECUTE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PROCEDURE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus.zcbus_func_ddl_command</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><blockquote><ul><li>用户授权</li></ul></blockquote><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#创建用户并赋权</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">create</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> role</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> with</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> password</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;zcbus@2025&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">grant</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> connect</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> database</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_settlement</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GRANT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> USAGE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ON</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SCHEMA</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TO</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GRANT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> USAGE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ON</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SCHEMA</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TO</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_read_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GRANT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> USAGE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ON</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SCHEMA</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TO</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GRANT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ALL</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PRIVILEGES</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ON</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ALL</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TABLES</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> IN</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SCHEMA</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TO</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GRANT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ALL</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PRIVILEGES</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ON</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ALL</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TABLES</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> IN</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SCHEMA</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TO</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_read_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GRANT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ALL</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PRIVILEGES</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ON</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ALL</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TABLES</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> IN</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SCHEMA</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TO</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">grant</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> select,trigger</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> table</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus.ddl_event_tbl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">grant</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> execute</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ON</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> FUNCTION</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus.zcbus_func_ddl_command</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">to</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">--函数要加</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()否则会报错</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">alter</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> user</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> REPLICATION</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> search_path</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">--切换到zcbus</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> schema下还是不能执行赋权</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#无法赋权是因为添加了事件触发器，临时办法就是先删除掉时间触发器赋权以后再加回来</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">drop</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> EVENT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TRIGGER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus_et_ddl_command</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">drop</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> EVENT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TRIGGER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus_et_ddl_drop</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">grant</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> usage</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> schema</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_settlement</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">grant</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> select</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tables</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> in</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> schema</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ccci_settlement</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">alter</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> table</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus.ddl_event_tbl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> owner</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#授权完成后再把事件触发器加回来，保证ddl可以同步</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CREATE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> EVENT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TRIGGER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus_et_ddl_command</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ddl_command_end</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> EXECUTE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PROCEDURE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus.zcbus_func_ddl_command</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CREATE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> EVENT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TRIGGER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus_et_ddl_drop</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sql_drop</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> EXECUTE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PROCEDURE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus.zcbus_func_ddl_command</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">alter</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> role</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> login</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">--</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 设置zcbus允许登录</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ALTER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TABLE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcbus.ddl_event_tbl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> REPLICA</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> IDENTITY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> FULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">--</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 开启补充日志</span></span></code></pre></div><h2 id="_3、主备集群使用逻辑复制需配置enable-slot-log参数" tabindex="-1">3、主备集群使用逻辑复制需配置enable_slot_log参数 <a class="header-anchor" href="#_3、主备集群使用逻辑复制需配置enable-slot-log参数" aria-label="Permalink to &quot;3、主备集群使用逻辑复制需配置enable_slot_log参数&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 海量数据库在主备集群模式下，使用逻辑复制功能需打开 enable_slot_log=on，主降备后会清理复制槽，未配置则需要手动清理，否则会导致该备节点xlog日志堆积</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vsql</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;show enable_slot_log;&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_guc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> set</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -I</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -N</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;enable_slot_log=on&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vb_ctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> reload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vsql</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;show enable_slot_log;&quot;</span></span></code></pre></div>`,15),l=[k];function t(p,F,e,d,E,r){return a(),i("div",null,l)}const C=s(h,[["render",t]]);export{y as __pageData,C as default};
